# ==============================================================================
# SINAG Production Docker Compose - GitHub Container Registry (GHCR)
# ==============================================================================
# This configuration pulls pre-built images from GitHub Container Registry.
# Designed for simple EC2 deployment by students.
#
# USAGE:
#   1. Copy .env.example to .env and fill in your values
#   2. Login to GHCR: echo $GITHUB_TOKEN | docker login ghcr.io -u USERNAME --password-stdin
#   3. Pull images: docker compose -f docker-compose.prod.yml pull
#   4. Start: docker compose -f docker-compose.prod.yml up -d
#   5. Run migrations: docker compose -f docker-compose.prod.yml exec api alembic upgrade head
#
# ==============================================================================

services:
  # ============================================================================
  # Redis - Message Broker for Celery
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: sinag-redis
    restart: unless-stopped

    volumes:
      - redis-data:/data

    command: redis-server --appendonly yes

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    networks:
      - sinag-network

  # ============================================================================
  # FastAPI Backend (from GHCR)
  # ============================================================================
  api:
    image: ghcr.io/${GITHUB_REPOSITORY}/sinag-api:${IMAGE_TAG:-latest}
    container_name: sinag-api
    restart: unless-stopped

    expose:
      - "8000"

    environment:
      # Application
      - ENVIRONMENT=production
      - DEBUG=false
      - FAIL_FAST=true
      - SECRET_KEY=${SECRET_KEY}
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=10080
      # User credentials (required in production)
      - FIRST_SUPERUSER_PASSWORD=${FIRST_SUPERUSER_PASSWORD}
      - EXTERNAL_USER_DEFAULT_PASSWORD=${EXTERNAL_USER_DEFAULT_PASSWORD}
      # Database (Supabase)
      - DATABASE_URL=${DATABASE_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - REQUIRE_ALL_CONNECTIONS=true
      # Redis/Celery (internal Docker network)
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - REDIS_URL=redis://redis:6379/0
      - REQUIRE_CELERY=true
      # AI (required)
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - REQUIRE_GEMINI=true

    depends_on:
      redis:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

    networks:
      - sinag-network

  # ============================================================================
  # Celery Worker (from GHCR - same image as API)
  # ============================================================================
  celery-worker:
    image: ghcr.io/${GITHUB_REPOSITORY}/sinag-api:${IMAGE_TAG:-latest}
    container_name: sinag-celery-worker
    restart: unless-stopped

    command: >
      celery -A app.core.celery_app worker
      --loglevel=info
      --queues=notifications,classification
      --concurrency=2

    environment:
      # Application
      - ENVIRONMENT=production
      - DEBUG=false
      - FAIL_FAST=true
      - SECRET_KEY=${SECRET_KEY}
      # User credentials (required in production)
      - FIRST_SUPERUSER_PASSWORD=${FIRST_SUPERUSER_PASSWORD}
      - EXTERNAL_USER_DEFAULT_PASSWORD=${EXTERNAL_USER_DEFAULT_PASSWORD}
      # Database (Supabase)
      - DATABASE_URL=${DATABASE_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - REQUIRE_ALL_CONNECTIONS=true
      # Redis/Celery (internal Docker network)
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - REDIS_URL=redis://redis:6379/0
      - REQUIRE_CELERY=true
      # AI (required)
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - REQUIRE_GEMINI=true

    depends_on:
      api:
        condition: service_healthy
      redis:
        condition: service_healthy

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

    networks:
      - sinag-network

  # ============================================================================
  # Next.js Frontend (from GHCR)
  # ============================================================================
  # NOTE: NEXT_PUBLIC_* variables are baked at build time in GitHub Actions.
  # Set them in GitHub repo Settings > Secrets and variables > Actions > Variables
  # ============================================================================
  web:
    image: ghcr.io/${GITHUB_REPOSITORY}/sinag-web:${IMAGE_TAG:-latest}
    container_name: sinag-web
    restart: unless-stopped

    expose:
      - "3000"

    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1

    depends_on:
      api:
        condition: service_healthy

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

    networks:
      - sinag-network

  # ============================================================================
  # Nginx Reverse Proxy (from GHCR)
  # ============================================================================
  nginx:
    image: ghcr.io/${GITHUB_REPOSITORY}/sinag-nginx:${IMAGE_TAG:-latest}
    container_name: sinag-nginx
    restart: unless-stopped

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - nginx-logs:/var/log/nginx
      - certbot-conf:/etc/letsencrypt:ro
      - certbot-www:/var/www/certbot:ro

    depends_on:
      api:
        condition: service_healthy
      web:
        condition: service_started

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

    networks:
      - sinag-network

  # ============================================================================
  # Certbot - SSL Certificate Management (Let's Encrypt)
  # ============================================================================
  certbot:
    image: certbot/certbot:latest
    container_name: sinag-certbot
    restart: unless-stopped

    volumes:
      - certbot-conf:/etc/letsencrypt
      - certbot-www:/var/www/certbot
      - /var/run/docker.sock:/var/run/docker.sock:ro

    # Renew certificates every 12 hours and reload Nginx on successful renewal
    # The deploy-hook runs only when certificates are actually renewed
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --deploy-hook \"docker kill --signal=HUP sinag-nginx\" 2>/dev/null || true; sleep 12h & wait $${!}; done;'"

    depends_on:
      - nginx

    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

    networks:
      - sinag-network

# ==============================================================================
# Networks
# ==============================================================================
networks:
  sinag-network:
    driver: bridge

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  redis-data:
    driver: local
  nginx-logs:
    driver: local
  certbot-conf:
    driver: local
  certbot-www:
    driver: local
