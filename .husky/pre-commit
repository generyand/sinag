#!/bin/sh

# Run lint-staged for TypeScript/JavaScript files
pnpm exec lint-staged

# Run backend checks for Python files if any are staged
if git diff --cached --name-only | grep -qE 'apps/api/.*\.py$'; then
  echo "Running Python linting on staged files..."
  cd apps/api

  # Get list of staged Python files
  STAGED_PY_FILES=$(git diff --cached --name-only | grep -E 'apps/api/.*\.py$' | sed 's|apps/api/||')

  if [ -n "$STAGED_PY_FILES" ]; then
    # Determine ruff command
    RUFF_CMD="ruff"
    if [ -f ".venv/bin/ruff" ]; then
      RUFF_CMD=".venv/bin/ruff"
    fi

    # Run ruff check
    echo "$STAGED_PY_FILES" | xargs $RUFF_CMD check --fix
    if [ $? -ne 0 ]; then
      echo "Ruff check failed. Please fix the issues before committing."
      exit 1
    fi

    # Run ruff format check
    echo "$STAGED_PY_FILES" | xargs $RUFF_CMD format --check
    if [ $? -ne 0 ]; then
      echo "Ruff format check failed. Run 'ruff format .' to fix formatting."
      exit 1
    fi
  fi

  cd - > /dev/null
fi

echo "Pre-commit checks passed!"
