#!/bin/sh

# Run lint-staged for TypeScript/JavaScript files
pnpm exec lint-staged

# Run backend checks for Python files if any are staged
STAGED_PY_FILES_FULL=$(git diff --cached --name-only | grep -E 'apps/api/.*\.py$' || true)

if [ -n "$STAGED_PY_FILES_FULL" ]; then
  echo "Running Python linting on staged files..."
  cd apps/api

  # Convert to paths relative to apps/api
  STAGED_PY_FILES=$(echo "$STAGED_PY_FILES_FULL" | sed 's|apps/api/||')

  # Determine ruff command
  RUFF_CMD="ruff"
  if [ -f ".venv/bin/ruff" ]; then
    RUFF_CMD=".venv/bin/ruff"
  fi

  # Run ruff check with auto-fix
  echo "$STAGED_PY_FILES" | xargs $RUFF_CMD check --fix
  if [ $? -ne 0 ]; then
    echo "Ruff check failed. Please fix the issues before committing."
    exit 1
  fi

  # Run ruff format (auto-format, not just check)
  echo "$STAGED_PY_FILES" | xargs $RUFF_CMD format

  # Go back to repo root
  cd - > /dev/null

  # Re-stage the formatted files
  echo "$STAGED_PY_FILES_FULL" | xargs git add
fi

echo "Pre-commit checks passed!"
