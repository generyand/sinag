# ==============================================================================
# Deploy to EC2 with GitHub Environments
# ==============================================================================
# This workflow deploys SINAG to EC2 with environment-specific secrets:
#   - develop branch â†’ staging environment
#   - main branch â†’ production environment (requires approval)
#
# TRIGGERS:
#   - Manual trigger (workflow_dispatch)
#   - After successful build on main or develop branch
# ==============================================================================

name: Deploy to EC2

on:
  # Manual trigger with environment selection
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      run_migrations:
        description: 'Run database migrations'
        required: false
        default: false
        type: boolean

  # Auto-deploy after successful build
  workflow_run:
    workflows: ["Build and Push to GHCR"]
    types:
      - completed
    branches:
      - main
      - develop

jobs:
  # ==========================================================================
  # Determine which environment to deploy to
  # ==========================================================================
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      image_tag: ${{ steps.set-env.outputs.image_tag }}
    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - use selected environment
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            if [ "${{ inputs.environment }}" == "production" ]; then
              echo "image_tag=latest" >> $GITHUB_OUTPUT
            else
              echo "image_tag=develop" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event.workflow_run.head_branch }}" == "main" ]; then
            # Auto-deploy main â†’ production
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "image_tag=latest" >> $GITHUB_OUTPUT
          else
            # Auto-deploy develop â†’ staging
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "image_tag=develop" >> $GITHUB_OUTPUT
          fi

  # ==========================================================================
  # Deploy to staging (auto-deploy, no approval needed)
  # ==========================================================================
  deploy-staging:
    needs: setup
    if: needs.setup.outputs.environment == 'staging' && (github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    environment: staging  # Uses staging secrets

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Create .env file on EC2
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          cd ~/sinag

          cat > .env << 'EOF'
          # Auto-generated by GitHub Actions - DO NOT EDIT MANUALLY
          # Environment: STAGING
          # Last deployed: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          GITHUB_REPOSITORY=${{ github.repository }}
          IMAGE_TAG=${{ needs.setup.outputs.image_tag }}

          # Environment
          ENVIRONMENT=${{ vars.ENVIRONMENT || 'staging' }}

          # Security
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          FIRST_SUPERUSER_PASSWORD=${{ secrets.FIRST_SUPERUSER_PASSWORD }}
          EXTERNAL_USER_DEFAULT_PASSWORD=${{ secrets.EXTERNAL_USER_DEFAULT_PASSWORD }}

          # CORS
          BACKEND_CORS_ORIGINS=${{ vars.BACKEND_CORS_ORIGINS }}

          # Database & Supabase
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

          # AI
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          EOF

          echo "âœ“ Environment file created (staging)"
          ENVSSH

      - name: Login to GHCR on EC2
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          echo "âœ“ Logged into GHCR"
          ENVSSH

      - name: Pull and deploy
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          cd ~/sinag
          docker compose -f docker-compose.prod.yml pull
          docker compose -f docker-compose.prod.yml down --remove-orphans || true
          docker compose -f docker-compose.prod.yml up -d
          echo "âœ“ Staging deployed"
          ENVSSH

      - name: Run migrations
        if: ${{ inputs.run_migrations == true }}
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          cd ~/sinag
          sleep 15
          docker compose -f docker-compose.prod.yml exec -T api alembic upgrade head
          echo "âœ“ Migrations completed"
          ENVSSH

      - name: Health check
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          sleep 10
          if curl -sf http://localhost/health > /dev/null; then
            echo "âœ“ Staging is healthy!"
          else
            echo "âš  Health check failed"
            docker compose -f docker-compose.prod.yml ps
          fi
          ENVSSH

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/ec2_key

      - name: Summary
        run: |
          echo "## ðŸš€ Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** staging" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ needs.setup.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** http://${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Deploy to production (requires approval)
  # ==========================================================================
  deploy-production:
    needs: setup
    if: needs.setup.outputs.environment == 'production' && (github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    environment: production  # Uses production secrets + requires approval

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Create .env file on EC2
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          cd ~/sinag

          cat > .env << 'EOF'
          # Auto-generated by GitHub Actions - DO NOT EDIT MANUALLY
          # Environment: PRODUCTION
          # Last deployed: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          GITHUB_REPOSITORY=${{ github.repository }}
          IMAGE_TAG=${{ needs.setup.outputs.image_tag }}

          # Environment
          ENVIRONMENT=${{ vars.ENVIRONMENT || 'production' }}

          # Security
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          FIRST_SUPERUSER_PASSWORD=${{ secrets.FIRST_SUPERUSER_PASSWORD }}
          EXTERNAL_USER_DEFAULT_PASSWORD=${{ secrets.EXTERNAL_USER_DEFAULT_PASSWORD }}

          # CORS
          BACKEND_CORS_ORIGINS=${{ vars.BACKEND_CORS_ORIGINS }}

          # Database & Supabase
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

          # AI
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          EOF

          echo "âœ“ Environment file created (production)"
          ENVSSH

      - name: Login to GHCR on EC2
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          echo "âœ“ Logged into GHCR"
          ENVSSH

      - name: Pull and deploy
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          cd ~/sinag
          docker compose -f docker-compose.prod.yml pull
          docker compose -f docker-compose.prod.yml down --remove-orphans || true
          docker compose -f docker-compose.prod.yml up -d
          echo "âœ“ Production deployed"
          ENVSSH

      - name: Run migrations
        if: ${{ inputs.run_migrations == true }}
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          cd ~/sinag
          sleep 15
          docker compose -f docker-compose.prod.yml exec -T api alembic upgrade head
          echo "âœ“ Migrations completed"
          ENVSSH

      - name: Health check
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          sleep 10
          if curl -sf http://localhost/health > /dev/null; then
            echo "âœ“ Production is healthy!"
          else
            echo "âš  Health check failed"
            docker compose -f docker-compose.prod.yml ps
          fi
          ENVSSH

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/ec2_key

      - name: Summary
        run: |
          echo "## ðŸš€ Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** production" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ needs.setup.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** http://${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
