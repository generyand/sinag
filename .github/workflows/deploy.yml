# ==============================================================================
# Deploy to EC2 with GitHub Secrets
# ==============================================================================
# This workflow deploys SINAG to EC2 by:
#   1. SSH into EC2
#   2. Pull latest images from GHCR
#   3. Start containers with secrets injected from GitHub
#
# NO .env files stored on EC2 - secrets come from GitHub Secrets
#
# TRIGGERS:
#   - Manual trigger (workflow_dispatch)
#   - After successful build on main branch
# ==============================================================================

name: Deploy to EC2

on:
  # Manual trigger with optional inputs
  workflow_dispatch:
    inputs:
      run_migrations:
        description: 'Run database migrations'
        required: false
        default: 'false'
        type: boolean

  # Auto-deploy after successful build
  workflow_run:
    workflows: ["Build and Push to GHCR"]
    types:
      - completed
    branches:
      - main

env:
  COMPOSE_FILE: docker-compose.prod.yml

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run if build succeeded (for workflow_run trigger)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      # ----------------------------------------------------------------------
      # Setup SSH
      # ----------------------------------------------------------------------
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      # ----------------------------------------------------------------------
      # Create environment file on EC2 (from GitHub Secrets)
      # ----------------------------------------------------------------------
      - name: Create .env file on EC2
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          cd ~/sinag

          # Create .env from GitHub Secrets (passed via SSH)
          cat > .env << 'EOF'
          # Auto-generated by GitHub Actions - DO NOT EDIT MANUALLY
          # Last deployed: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # GitHub Container Registry
          GITHUB_REPOSITORY=${{ github.repository }}
          IMAGE_TAG=latest

          # Application Secrets
          SECRET_KEY=${{ secrets.SECRET_KEY }}

          # Database (Supabase)
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

          # AI (Required)
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          EOF

          echo "âœ“ Environment file created"
          ENVSSH

      # ----------------------------------------------------------------------
      # Login to GHCR on EC2
      # ----------------------------------------------------------------------
      - name: Login to GHCR on EC2
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          echo "âœ“ Logged into GHCR"
          ENVSSH

      # ----------------------------------------------------------------------
      # Pull latest images
      # ----------------------------------------------------------------------
      - name: Pull latest images
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          cd ~/sinag
          docker compose -f docker-compose.prod.yml pull
          echo "âœ“ Images pulled"
          ENVSSH

      # ----------------------------------------------------------------------
      # Deploy containers
      # ----------------------------------------------------------------------
      - name: Deploy containers
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          cd ~/sinag

          # Stop existing containers
          docker compose -f docker-compose.prod.yml down --remove-orphans || true

          # Start new containers
          docker compose -f docker-compose.prod.yml up -d

          echo "âœ“ Containers started"
          ENVSSH

      # ----------------------------------------------------------------------
      # Run migrations (if requested)
      # ----------------------------------------------------------------------
      - name: Run database migrations
        if: ${{ github.event.inputs.run_migrations == 'true' }}
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          cd ~/sinag

          echo "Waiting for API to be healthy..."
          sleep 15

          docker compose -f docker-compose.prod.yml exec -T api alembic upgrade head
          echo "âœ“ Migrations completed"
          ENVSSH

      # ----------------------------------------------------------------------
      # Health check
      # ----------------------------------------------------------------------
      - name: Health check
        run: |
          ssh -i ~/.ssh/ec2_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENVSSH'
          cd ~/sinag

          echo "Waiting for services to start..."
          sleep 10

          # Check health endpoint
          if curl -sf http://localhost/health > /dev/null; then
            echo "âœ“ Application is healthy!"
          else
            echo "âš  Health check failed - services may still be starting"
            docker compose -f docker-compose.prod.yml ps
          fi
          ENVSSH

      # ----------------------------------------------------------------------
      # Cleanup SSH key
      # ----------------------------------------------------------------------
      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/ec2_key

      # ----------------------------------------------------------------------
      # Summary
      # ----------------------------------------------------------------------
      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** ${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** latest" >> $GITHUB_STEP_SUMMARY
          echo "**Migrations:** ${{ github.event.inputs.run_migrations || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access" >> $GITHUB_STEP_SUMMARY
          echo "- Application: http://${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- API Docs: http://${{ secrets.EC2_HOST }}/docs" >> $GITHUB_STEP_SUMMARY
