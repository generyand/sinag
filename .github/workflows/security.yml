# ==============================================================================
# Security Scanning Workflow
# ==============================================================================
# This workflow performs security scans including:
#   - Dependency vulnerability scanning (npm audit, pip-audit)
#   - Docker image scanning (Trivy)
#   - Secret detection (Gitleaks)
#   - Static Application Security Testing (Semgrep)
#
# Runs on PRs, pushes to main/develop, and weekly scheduled scans.
# ==============================================================================

name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  # ============================================================================
  # Frontend Dependency Scanning
  # ============================================================================
  npm-audit:
    name: NPM Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install pnpm
        run: npm install -g pnpm@10.11.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit
        run: pnpm audit --audit-level=high
        continue-on-error: true

      - name: Generate audit report
        run: |
          echo "## NPM Audit Report" >> $GITHUB_STEP_SUMMARY
          pnpm audit --json > audit-report.json || true
          if [ -s audit-report.json ]; then
            echo "See artifact for full report" >> $GITHUB_STEP_SUMMARY
          else
            echo "No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-report
          path: audit-report.json
          retention-days: 30

  # ============================================================================
  # Backend Dependency Scanning
  # ============================================================================
  python-audit:
    name: Python Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Install uv and dependencies
        run: |
          pip install uv
          cd apps/api && uv pip install --system -e ".[dev]"

      - name: Run pip-audit
        run: |
          cd apps/api
          pip-audit --format=json --output=pip-audit-report.json || true
        continue-on-error: true

      - name: Generate audit summary
        run: |
          echo "## Python Dependency Audit" >> $GITHUB_STEP_SUMMARY
          if [ -f apps/api/pip-audit-report.json ]; then
            VULNS=$(cat apps/api/pip-audit-report.json | python3 -c "import json,sys; data=json.load(sys.stdin); print(len(data.get('vulnerabilities', [])))" 2>/dev/null || echo "0")
            echo "Found $VULNS vulnerabilities" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pip-audit-report
          path: apps/api/pip-audit-report.json
          retention-days: 30

  # ============================================================================
  # Docker Image Scanning with Trivy
  # ============================================================================
  trivy-scan:
    name: Trivy Container Scan
    runs-on: ubuntu-latest
    # Only run on main/develop pushes and scheduled runs
    if: github.event_name != 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build API image for scanning
        run: |
          docker build \
            -t sinag-api:scan \
            -f apps/api/Dockerfile \
            --target production \
            apps/api

      - name: Run Trivy vulnerability scanner (API)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "sinag-api:scan"
          format: "sarif"
          output: "trivy-api-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-api-results.sarif"
          category: "trivy-api"

      - name: Generate Trivy summary
        run: |
          echo "## Trivy Container Scan" >> $GITHUB_STEP_SUMMARY
          echo "Scanned sinag-api:scan for CRITICAL and HIGH vulnerabilities" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Secret Scanning with Gitleaks
  # ============================================================================
  gitleaks:
    name: Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # ============================================================================
  # SAST with Semgrep
  # ============================================================================
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/python
            p/typescript
            p/react
            p/docker
            p/secrets
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

  # ============================================================================
  # Security Summary
  # ============================================================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [npm-audit, python-audit, gitleaks, semgrep]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.npm-audit.result }}" == "success" ]; then
            echo "| NPM Audit | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| NPM Audit | :warning: Issues Found |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.python-audit.result }}" == "success" ]; then
            echo "| Python Audit | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Python Audit | :warning: Issues Found |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.gitleaks.result }}" == "success" ]; then
            echo "| Secret Detection | :white_check_mark: No Secrets Found |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Secret Detection | :x: Secrets Detected |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.semgrep.result }}" == "success" ]; then
            echo "| SAST (Semgrep) | :white_check_mark: Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| SAST (Semgrep) | :warning: Issues Found |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See individual job logs and artifacts for details." >> $GITHUB_STEP_SUMMARY
